<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>Matrice Contr√¥le Qualit√©</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script type="module">
    import { BrowserMultiFormatReader } from 'https://cdn.jsdelivr.net/npm/@zxing/browser@0.0.10/+esm';

    let codeReader = null;
    let isScanning = false;

    // Exposer BrowserMultiFormatReader et les variables globalement
    window.BrowserMultiFormatReader = BrowserMultiFormatReader;
    window.isScanning = false;
    window.isEanScanning = false;

    // Scanner via flux vid√©o en temps r√©el
    window.startCamera = async function() {
      const video = document.getElementById('video');
      const scanButton = document.getElementById('scanButton');
      const stopButton = document.getElementById('stopButton');
      
      try {
        // Arr√™ter toute session pr√©c√©dente
        if (codeReader) {
          codeReader.reset();
        }
        
        codeReader = new BrowserMultiFormatReader();
        const constraints = {
          video: {
            facingMode: 'environment', // Cam√©ra arri√®re
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        };
        
        await codeReader.decodeFromConstraints(constraints, video, (result, err) => {
          if (result && window.isScanning) {
            document.getElementById("barcodeInput").value = result.text;
            stopCamera();
            findProduct();
            // Vibration si support√©e
            if (navigator.vibrate) {
              navigator.vibrate(200);
            }
          }
        });
        
        window.isScanning = true;
        video.style.display = 'block';
        scanButton.style.display = 'none';
        stopButton.style.display = 'inline-block';
        document.getElementById('scannerContainer').style.display = 'block';
        
      } catch (err) {
        console.error('Erreur cam√©ra:', err);
        alert('Impossible d\'acc√©der √† la cam√©ra. V√©rifiez les permissions.');
        resetCameraButtons();
      }
    };

    window.stopCamera = function() {
      window.isScanning = false;
      
      // Arr√™ter le flux vid√©o
      const video = document.getElementById('video');
      if (video && video.srcObject) {
        const stream = video.srcObject;
        if (stream) {
          stream.getTracks().forEach(track => {
            track.stop();
            console.log('Track arr√™t√©:', track.kind);
          });
          video.srcObject = null;
        }
      }
      
      // Arr√™ter le code reader
      if (codeReader) {
        try {
          codeReader.reset();
        } catch (e) {
          console.log('Erreur lors de l\'arr√™t de la cam√©ra:', e);
        }
        codeReader = null;
      }
      
      resetCameraButtons();
    };

    function resetCameraButtons() {
      const video = document.getElementById('video');
      if (video) {
        video.style.display = 'none';
        // S'assurer que le flux est bien coup√©
        if (video.srcObject) {
          video.srcObject = null;
        }
      }
      
      document.getElementById('scanButton').style.display = 'inline-block';
      document.getElementById('stopButton').style.display = 'none';
      document.getElementById('scannerContainer').style.display = 'none';
    }
  </script>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea, #764ba2);
      margin: 0;
      padding: 10px;
      color: #2c3e50;
      min-height: 100vh;
    }
    
    .container {
      background: white;
      padding: 20px;
      border-radius: 15px;
      max-width: 100%;
      margin: auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    h1 {
      text-align: center;
      margin-bottom: 20px;
      background: linear-gradient(45deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-size: 1.5em;
    }
    
    .section {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      background: #f8f9fa;
    }
    
    .section h3 {
      margin: 0 0 15px 0;
      color: #495057;
      font-size: 1.1em;
    }
    
    .section.active {
      border-color: #667eea;
      background: #f0f3ff;
    }
    
    .section.completed {
      border-color: #28a745;
      background: #f0fff4;
    }
    
    input[type="file"], input[type="text"] {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    
    button {
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
      color: white;
      padding: 12px 20px;
      margin: 5px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
      min-height: 44px;
    }
    
    button:active {
      transform: scale(0.98);
    }
    
    button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    
    .button-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .button-row button {
      flex: 1;
      min-width: 120px;
    }
    
    #scannerContainer {
      display: none;
      text-align: center;
      margin: 15px 0;
    }
    
    #video {
      width: 100%;
      max-width: 400px;
      height: 300px;
      border: 2px solid #667eea;
      border-radius: 10px;
      object-fit: cover;
    }
    
    #eanVideo {
      width: 100%;
      max-width: 400px;
      height: 300px;
      border: 2px solid #667eea;
      border-radius: 10px;
      object-fit: cover;
    }
    
    .scanner-overlay {
      position: relative;
      display: inline-block;
    }
    
    .scanner-frame {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 250px;
      height: 150px;
      border: 2px solid #00ff00;
      border-radius: 10px;
      pointer-events: none;
    }
    
    .scanner-corners {
      position: absolute;
      width: 20px;
      height: 20px;
      border: 3px solid #00ff00;
    }
    
    .corner-tl { top: -2px; left: -2px; border-right: none; border-bottom: none; }
    .corner-tr { top: -2px; right: -2px; border-left: none; border-bottom: none; }
    .corner-bl { bottom: -2px; left: -2px; border-right: none; border-top: none; }
    .corner-br { bottom: -2px; right: -2px; border-left: none; border-top: none; }
    
    #results, #productListContainer, #qualityControlSection {
      margin-top: 15px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: #f8f9fa;
    }
    
    .item {
      padding: 12px;
      border-bottom: 1px solid #ccc;
      line-height: 1.4;
    }
    
    .item:last-child {
      border-bottom: none;
    }
    
    .item strong {
      color: #667eea;
      font-size: 1.1em;
    }
    
    #fileStatus {
      color: #28a745;
      font-weight: bold;
      margin: 10px 0;
    }
    
    .scan-instruction {
      text-align: center;
      color: #666;
      font-size: 0.9em;
      margin: 10px 0;
    }
    
    /* Styles pour la liste de produits */
    #searchInput {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    
    .product-item {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .product-item:hover {
      background-color: #e9ecef;
    }
    
    .product-item:last-child {
      border-bottom: none;
    }
    
    .product-ref {
      font-weight: bold;
      color: #667eea;
      font-size: 1.1em;
    }
    
    .product-details {
      font-size: 0.9em;
      color: #666;
      margin-top: 5px;
    }
    
    .no-results {
      text-align: center;
      padding: 20px;
      color: #6c757d;
      font-style: italic;
    }
    
    /* Styles pour le contr√¥le qualit√© */
    .quality-criterion {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
    }
    
    .criterion-title {
      font-weight: bold;
      color: #495057;
      margin-bottom: 10px;
      font-size: 1.1em;
    }
    
    .radio-group {
      display: flex;
      gap: 20px;
      margin: 10px 0;
      align-items: center;
    }
    
    .radio-option {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    
    .radio-option input[type="radio"] {
      width: 18px;
      height: 18px;
      margin: 0;
    }
    
    .radio-option.ok {
      color: #28a745;
      font-weight: bold;
    }
    
    .radio-option.not-ok {
      color: #dc3545;
      font-weight: bold;
    }
    
    .radio-option.not-applicable {
      color: #6c757d;
      font-weight: bold;
    }
    
    .comment-area {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
      resize: vertical;
      min-height: 60px;
      margin-top: 10px;
    }
    
    .product-info {
      background: #e8f4f8;
      border: 1px solid #bee5eb;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    
    .product-info h4 {
      margin: 0 0 10px 0;
      color: #0c5460;
    }
    
    .hidden {
      display: none;
    }
    
    /* Styles pour le contr√¥le EAN */
    .ean-progress {
      background: #e8f4f8;
      border: 1px solid #bee5eb;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .ean-progress h4 {
      margin: 0 0 10px 0;
      color: #0c5460;
    }
    
    .progress-bar {
      background: #e9ecef;
      border-radius: 10px;
      height: 20px;
      overflow: hidden;
      margin: 10px 0;
    }
    
    .progress-fill {
      background: linear-gradient(90deg, #28a745, #20c997);
      height: 100%;
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 10px;
    }
    
    .progress-text {
      font-weight: bold;
      color: #495057;
      margin-top: 5px;
    }
    
    .ean-scanner-section, .ean-list-section {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }
    
    .ean-scanner-section h4, .ean-list-section h4 {
      margin: 0 0 15px 0;
      color: #495057;
    }
    
    .ean-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      margin: 8px 0;
      transition: all 0.3s ease;
    }
    
    .ean-item.checked {
      background: #d4edda;
      border-color: #c3e6cb;
    }
    
    .ean-item.checked .ean-status {
      color: #155724;
    }
    
    .ean-details {
      flex: 1;
    }
    
    .ean-code {
      font-family: monospace;
      font-weight: bold;
      color: #495057;
      font-size: 1.1em;
    }
    
    .ean-info {
      font-size: 0.9em;
      color: #6c757d;
      margin-top: 3px;
    }
    
    .ean-status {
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 0.9em;
    }
    
    .ean-status.pending {
      background: #fff3cd;
      color: #856404;
    }
    
    .ean-status.found {
      background: #d4edda;
      color: #155724;
    }
    
    .validation-summary {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }
    
    .validation-summary.success {
      background: #d4edda;
      border-color: #c3e6cb;
    }
    
    .validation-summary.warning {
      background: #fff3cd;
      border-color: #ffeaa7;
    }
    
    .validation-summary h4 {
      margin: 0 0 10px 0;
    }
    
    /* Styles pour les photos */
    .photo-section {
      margin-top: 10px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 5px;
      border: 1px solid #e9ecef;
    }
    
    .photo-upload {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .photo-upload input[type="file"] {
      flex: 1;
      padding: 8px;
      border: 2px solid #e9ecef;
      border-radius: 6px;
      font-size: 0.85rem;
    }
    
    .photo-button {
      background: #17a2b8;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      white-space: nowrap;
    }
    
    .photo-button:hover {
      background: #138496;
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(23, 162, 184, 0.3);
    }
    
    .photo-preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    
    .photo-item {
      position: relative;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      overflow: hidden;
      background: #f8f9fa;
      transition: all 0.3s ease;
    }
    
    .photo-item:hover {
      border-color: #28a745;
      transform: scale(1.02);
    }
    
    .photo-item img {
      width: 100%;
      height: 100px;
      object-fit: cover;
      display: block;
    }
    
    .photo-remove {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(220, 53, 69, 0.9);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    
    .photo-remove:hover {
      background: #dc3545;
      transform: scale(1.1);
    }
    
    .photo-timestamp {
      padding: 5px;
      font-size: 0.7rem;
      color: #6c757d;
      text-align: center;
      background: rgba(248, 249, 250, 0.9);
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 15px;
        margin: 5px;
      }
      
      h1 {
        font-size: 1.3em;
      }
      
      .section {
        padding: 12px;
      }
      
      button {
        padding: 10px 15px;
        font-size: 13px;
      }
      
      #video {
        height: 250px;
      }
      
      #eanVideo {
        height: 250px;
      }
      
      .scanner-frame {
        width: 200px;
        height: 120px;
      }
      
      .radio-group {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .quality-criterion {
        padding: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Matrice Contr√¥le Qualit√©</h1>

    <div class="section completed" id="step1">
      <h3>1Ô∏è‚É£ Charger la base de donn√©es</h3>
      <div class="button-row">
        <button onclick="loadOnlineCSV()">üåê Charger BDD en ligne</button>
        <button onclick="document.getElementById('csvFile').click()">üìÅ Charger fichier local</button>
      </div>
      <input type="file" id="csvFile" accept=".csv" style="display:none;" onchange="loadCSV()" />
      <div id="fileStatus"></div>
    </div>

    <div class="section" id="step2">
      <h3>2Ô∏è‚É£ Scanner un code-barres</h3>
      
      <div class="button-row">
        <button id="scanButton" onclick="startCamera()">üì∑ Scanner en direct</button>
        <button id="stopButton" onclick="stopCamera()" style="display:none;">‚èπÔ∏è Arr√™ter</button>
        <button onclick="showProductList()">üìã Choisir dans la liste</button>
      </div>
      
      <div id="scannerContainer">
        <div class="scanner-overlay">
          <video id="video" playsinline></video>
          <div class="scanner-frame">
            <div class="scanner-corners corner-tl"></div>
            <div class="scanner-corners corner-tr"></div>
            <div class="scanner-corners corner-bl"></div>
            <div class="scanner-corners corner-br"></div>
          </div>
        </div>
        <div class="scan-instruction">Placez le code-barres dans le cadre</div>
      </div>
      
      <div id="productListContainer" style="display:none;">
        <h4>üîç Rechercher une r√©f√©rence</h4>
        <input type="text" id="searchInput" placeholder="Rechercher par r√©f√©rence, code, marque..." onkeyup="filterProducts()" />
        <div id="productList" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; margin: 10px 0;"></div>
        <button onclick="hideProductList()" style="background: #6c757d;">‚ùå Fermer la liste</button>
      </div>
      
      <label>‚å®Ô∏è Ou saisir manuellement :</label>
      <input type="text" id="barcodeInput" placeholder="Entrer un code EAN..." />
      <button onclick="findProduct()">üîç Rechercher</button>
    </div>

    <div id="results" style="display:none;"></div>

    <div class="section hidden" id="step3">
      <h3>3Ô∏è‚É£ Contr√¥le Qualit√© - Carton</h3>
      
      <div class="product-info" id="selectedProductInfo">
        <!-- Informations du produit s√©lectionn√© -->
      </div>

      <div id="qualityControlSection">
        
        <!-- Shipping Mark -->
        <div class="quality-criterion">
          <div class="criterion-title">üì¶ Shipping Mark</div>
          <div class="radio-group">
            <label class="radio-option ok">
              <input type="radio" name="shipping_mark" value="ok" onchange="updatePackageQualityStatus()">
              ‚úÖ OK
            </label>
            <label class="radio-option not-ok">
              <input type="radio" name="shipping_mark" value="not_ok" onchange="updatePackageQualityStatus()">
              ‚ùå PAS OK
            </label>
          </div>
          <textarea class="comment-area" id="comment_shipping_mark" placeholder="Commentaire (optionnel)..."></textarea>
          <div class="photo-section">
            <div class="photo-upload">
              <input type="file" id="photoInput_shipping_mark" accept="image/*" multiple>
              <button class="photo-button" onclick="addPhotos('shipping_mark')">üì∑ Ajouter Photos</button>
            </div>
            <div class="photo-preview" id="photos_shipping_mark"></div>
          </div>
        </div>

        <!-- Etat du colis -->
        <div class="quality-criterion">
          <div class="criterion-title">üìã Etat du colis</div>
          <div class="radio-group">
            <label class="radio-option ok">
              <input type="radio" name="package_condition" value="ok" onchange="updatePackageQualityStatus()">
              ‚úÖ OK
            </label>
            <label class="radio-option not-ok">
              <input type="radio" name="package_condition" value="not_ok" onchange="updatePackageQualityStatus()">
              ‚ùå PAS OK
            </label>
          </div>
          <textarea class="comment-area" id="comment_package_condition" placeholder="Commentaire (optionnel)..."></textarea>
          <div class="photo-section">
            <div class="photo-upload">
              <input type="file" id="photoInput_package_condition" accept="image/*" multiple>
              <button class="photo-button" onclick="addPhotos('package_condition')">üì∑ Ajouter Photos</button>
            </div>
            <div class="photo-preview" id="photos_package_condition"></div>
          </div>
        </div>

        <!-- Bande de garantie -->
        <div class="quality-criterion">
          <div class="criterion-title">üîí Bande de garantie</div>
          <div class="radio-group">
            <label class="radio-option ok">
              <input type="radio" name="warranty_seal" value="ok" onchange="updatePackageQualityStatus()">
              ‚úÖ OK
            </label>
            <label class="radio-option not-ok">
              <input type="radio" name="warranty_seal" value="not_ok" onchange="updatePackageQualityStatus()">
              ‚ùå PAS OK
            </label>
          </div>
          <textarea class="comment-area" id="comment_warranty_seal" placeholder="Commentaire (optionnel)..."></textarea>
          <div class="photo-section">
            <div class="photo-upload">
              <input type="file" id="photoInput_warranty_seal" accept="image/*" multiple>
              <button class="photo-button" onclick="addPhotos('warranty_seal')">üì∑ Ajouter Photos</button>
            </div>
            <div class="photo-preview" id="photos_warranty_seal"></div>
          </div>
        </div>

      </div>

      <div class="button-row">
        <button onclick="proceedToProductControl()" id="packageValidateButton" disabled>‚û°Ô∏è Contr√¥ler le produit</button>
        <button onclick="generateQualityReport()" style="background: #dc3545;">üìÑ G√©n√©rer rapport PDF</button>
        <button onclick="resetQualityControl()" style="background: #6c757d;">üîÑ Recommencer</button>
      </div>
    </div>

    <div class="section hidden" id="step4">
      <h3>4Ô∏è‚É£ Contr√¥le Qualit√© - Produit</h3>
      
      <div class="product-info" id="productControlInfo">
        <!-- Informations du produit s√©lectionn√© -->
      </div>

      <div id="productQualityControlSection">
        
        <!-- Test du zip -->
        <div class="quality-criterion">
          <div class="criterion-title">ü§ê V√©rification zip </div>
          <div class="radio-group">
            <label class="radio-option ok">
              <input type="radio" name="zip_test" value="ok" onchange="updateProductQualityStatus()">
              ‚úÖ OK
            </label>
            <label class="radio-option not-ok">
              <input type="radio" name="zip_test" value="not_ok" onchange="updateProductQualityStatus()">
              ‚ùå PAS OK
            </label>
            <label class="radio-option">
              <input type="radio" name="zip_test" value="not_applicable" onchange="updateProductQualityStatus()">
              ‚ûñ Non applicable
            </label>
          </div>
          <textarea class="comment-area" id="comment_zip_test" placeholder="Commentaire (optionnel)..."></textarea>
          <div class="photo-section">
            <div class="photo-upload">
              <input type="file" id="photoInput_zip_test" accept="image/*" multiple>
              <button class="photo-button" onclick="addPhotos('zip_test')">üì∑ Ajouter Photos</button>
            </div>
            <div class="photo-preview" id="photos_zip_test"></div>
          </div>
        </div>

        <!-- V√©rification boutonnage -->
        <div class="quality-criterion">
          <div class="criterion-title">üîò V√©rification boutonnage</div>
          <div class="radio-group">
            <label class="radio-option ok">
              <input type="radio" name="button_check" value="ok" onchange="updateProductQualityStatus()">
              ‚úÖ OK
            </label>
            <label class="radio-option not-ok">
              <input type="radio" name="button_check" value="not_ok" onchange="updateProductQualityStatus()">
              ‚ùå PAS OK
            </label>
            <label class="radio-option">
              <input type="radio" name="button_check" value="not_applicable" onchange="updateProductQualityStatus()">
              ‚ûñ Non applicable
            </label>
          </div>
          <textarea class="comment-area" id="comment_button_check" placeholder="Commentaire (optionnel)..."></textarea>
          <div class="photo-section">
            <div class="photo-upload">
              <input type="file" id="photoInput_button_check" accept="image/*" multiple>
              <button class="photo-button" onclick="addPhotos('button_check')">üì∑ Ajouter Photos</button>
            </div>
            <div class="photo-preview" id="photos_button_check"></div>
          </div>
        </div>

        <!-- Contr√¥le Coloris -->
        <div class="quality-criterion">
          <div class="criterion-title">üé® V√©rification Coloris</div>
          <div class="radio-group">
            <label class="radio-option ok">
              <input type="radio" name="color_check" value="ok" onchange="updateProductQualityStatus()">
              ‚úÖ OK
            </label>
            <label class="radio-option not-ok">
              <input type="radio" name="color_check" value="not_ok" onchange="updateProductQualityStatus()">
              ‚ùå PAS OK
            </label>
          </div>
          <textarea class="comment-area" id="comment_color_check" placeholder="Commentaire (optionnel)..."></textarea>
          <div class="photo-section">
            <div class="photo-upload">
              <input type="file" id="photoInput_color_check" accept="image/*" multiple>
              <button class="photo-button" onclick="addPhotos('color_check')">üì∑ Ajouter Photos</button>
            </div>
            <div class="photo-preview" id="photos_color_check"></div>
          </div>
        </div>

        <!-- V√©rification finition/coutures -->
        <div class="quality-criterion">
          <div class="criterion-title">‚úÇÔ∏è V√©rification finition/coutures</div>
          <div class="radio-group">
            <label class="radio-option ok">
              <input type="radio" name="finishing_check" value="ok" onchange="updateProductQualityStatus()">
              ‚úÖ OK
            </label>
            <label class="radio-option not-ok">
              <input type="radio" name="finishing_check" value="not_ok" onchange="updateProductQualityStatus()">
              ‚ùå PAS OK
            </label>
          </div>
          <textarea class="comment-area" id="comment_finishing_check" placeholder="Commentaire (optionnel)..."></textarea>
          <div class="photo-section">
            <div class="photo-upload">
              <input type="file" id="photoInput_finishing_check" accept="image/*" multiple>
              <button class="photo-button" onclick="addPhotos('finishing_check')">üì∑ Ajouter Photos</button>
            </div>
            <div class="photo-preview" id="photos_finishing_check"></div>
          </div>
        </div>

      </div>

      <div class="button-row">
        <button onclick="proceedToEanControl()" id="productValidateButton" disabled>‚û°Ô∏è Contr√¥ler les EAN de la r√©f√©rence</button>
        <button onclick="generateQualityReport()" style="background: #dc3545;">üìÑ G√©n√©rer rapport PDF</button>
        <button onclick="goBackToPackageControl()" style="background: #ffc107; color: #000;">‚¨ÖÔ∏è Retour carton</button>
        <button onclick="resetQualityControl()" style="background: #6c757d;">üîÑ Recommencer</button>
      </div>
    </div>

    <div class="section hidden" id="step5">
      <h3>5Ô∏è‚É£ Contr√¥le EAN - R√©f√©rence</h3>
      
      <div class="product-info" id="eanControlInfo">
        <!-- Informations de la r√©f√©rence √† contr√¥ler -->
      </div>

      <div id="eanControlSection">
        <div class="ean-progress">
          <h4>üìä Progression du contr√¥le</h4>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <div class="progress-text" id="progressText">0 / 0 EAN contr√¥l√©s</div>
        </div>

        <div class="ean-scanner-section">
          <h4>üîç Scanner les EAN de la r√©f√©rence</h4>
          <div class="button-row">
            <button id="eanScanButton" onclick="startEanScanner()">üì∑ Scanner EAN</button>
            <button id="eanStopButton" onclick="stopEanScanner()" style="display:none;">‚èπÔ∏è Arr√™ter</button>
          </div>
          
          <div id="eanScannerContainer" style="display:none;">
            <div class="scanner-overlay">
              <video id="eanVideo" playsinline></video>
              <div class="scanner-frame">
                <div class="scanner-corners corner-tl"></div>
                <div class="scanner-corners corner-tr"></div>
                <div class="scanner-corners corner-bl"></div>
                <div class="scanner-corners corner-br"></div>
              </div>
            </div>
            <div class="scan-instruction">Scanner les codes-barres de la r√©f√©rence</div>
          </div>
          
          <label>‚å®Ô∏è Ou saisir manuellement :</label>
          <input type="text" id="eanInput" placeholder="Scanner ou saisir un EAN de la r√©f√©rence..." />
          <button onclick="checkEanForReference()">üîç V√©rifier EAN</button>
        </div>

        <div class="ean-list-section">
          <h4>üìã Liste des EAN √† contr√¥ler</h4>
          <div id="eanList"></div>
        </div>

        <div id="eanValidationResult" style="display:none;"></div>
      </div>

      <div class="button-row">
        <button onclick="validateCompleteControl()" id="completeValidateButton" disabled>‚úÖ Finaliser le contr√¥le complet</button>
        <button onclick="generateQualityReport()" id="generateReportButton" style="background: #dc3545;">üìÑ G√©n√©rer rapport PDF</button>
        <button onclick="goBackToProductControl()" style="background: #ffc107; color: #000;">‚¨ÖÔ∏è Retour produit</button>
        <button onclick="resetQualityControl()" style="background: #6c757d;">üîÑ Recommencer</button>
      </div>
    </div>

  </div>

  <script>
    let database = [];
    let currentProduct = null;
    let packageQualityResults = {};
    let productQualityResults = {};
    let currentReference = null;
    let referenceEanList = [];
    let checkedEans = new Set();
    let nonTestedEans = new Set(); // EAN marqu√©s comme non test√©s
    let eanCodeReader = null;
    
    // Variables pour la gestion des photos (simplifi√©es)
    let criterionPhotos = {}; // Stockage des photos par crit√®re

    const COL_REF = 0;
    const COL_CODE = 1;
    const COL_COULEUR = 2;
    const COL_TAILLE = 4;
    const COL_MARQUE = 7;
    const COL_EAN = 10;

    function loadCSV() {
      const file = document.getElementById('csvFile').files[0];
      if (!file) return alert("‚ö†Ô∏è S√©lectionnez un fichier CSV.");
      
      Papa.parse(file, {
        header: false,
        delimiter: ";",
        skipEmptyLines: true,
        complete: results => {
          database = results.data.slice(1);
          document.getElementById("fileStatus").innerHTML = 
            `‚úÖ ${database.length} articles charg√©s avec succ√®s`;
          document.getElementById('step1').classList.add('completed');
          document.getElementById('step2').classList.add('active');
        },
        error: (error) => {
          alert("‚ùå Erreur lors du chargement du fichier CSV");
          console.error(error);
        }
      });
    }

    function loadOnlineCSV() {
      document.getElementById("fileStatus").innerHTML = "‚è≥ Chargement de la base de donn√©es en ligne...";
      
      const alternativeUrls = [
        'https://cdn.jsdelivr.net/gh/rbmfinance1/26002@gh-pages/bdd.csv',
        'https://raw.githubusercontent.com/rbmfinance1/26002/gh-pages/bdd.csv',
        'https://rbmfinance1.github.io/26002/bdd.csv'
      ];
      
      async function tryUrls(urlIndex = 0) {
        if (urlIndex >= alternativeUrls.length) {
          console.log('Toutes les sources ont √©chou√©');
          showManualDownloadOption();
          return;
        }
        
        const currentUrl = alternativeUrls[urlIndex];
        console.log(`Tentative ${urlIndex + 1}:`, currentUrl);
        
        try {
          const response = await fetch(currentUrl, {
            method: 'GET',
            mode: 'cors',
            cache: 'no-cache',
            headers: {
              'Accept': 'text/csv,text/plain,*/*'
            }
          });
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const csvData = await response.text();
          
          if (csvData.includes('<!DOCTYPE') || csvData.includes('<html>')) {
            throw new Error('Contenu HTML re√ßu au lieu de CSV');
          }
          
          if (csvData.trim().length < 10) {
            throw new Error('Fichier CSV vide ou trop court');
          }
          
          console.log('‚úÖ Chargement r√©ussi avec:', currentUrl);
          processCsvData(csvData);
          
        } catch (error) {
          console.log(`Source ${urlIndex + 1} √©chou√©e:`, error.message);
          tryUrls(urlIndex + 1);
        }
      }
      
      tryUrls(0);
    }

    function showManualDownloadOption() {
      document.getElementById("fileStatus").innerHTML = 
        `<div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin: 10px 0;">
          <strong>üì• T√©l√©chargement manuel requis</strong><br/><br/>
          <div style="margin: 10px 0;">
            <a href="https://rbmfinance1.github.io/26002/bdd.csv" 
               download="bdd.csv" 
               style="background: #007bff; color: white; padding: 10px 15px; text-decoration: none; border-radius: 5px; display: inline-block; margin: 5px 0;">
              üì• T√©l√©charger bdd.csv
            </a>
          </div>
          <small style="color: #856404;">
            1. Cliquez sur le lien ci-dessus pour t√©l√©charger<br/>
            2. Une fois t√©l√©charg√©, utilisez "üìÅ Charger fichier local"<br/>
            3. S√©lectionnez le fichier bdd.csv t√©l√©charg√©
          </small>
        </div>`;
    }

    function processCsvData(csvData) {
      try {
        Papa.parse(csvData, {
          header: false,
          delimiter: ";",
          skipEmptyLines: true,
          complete: results => {
            if (results.data && results.data.length > 1) {
              database = results.data.slice(1);
              document.getElementById("fileStatus").innerHTML = 
                `‚úÖ ${database.length} articles charg√©s depuis la base en ligne`;
              document.getElementById('step1').classList.add('completed');
              document.getElementById('step2').classList.add('active');
            } else {
              throw new Error('Fichier CSV vide ou invalide');
            }
          },
          error: (error) => {
            console.error('Erreur Papa Parse:', error);
            document.getElementById("fileStatus").innerHTML = 
              "‚ùå Erreur lors du traitement du fichier CSV";
          }
        });
      } catch (error) {
        console.error('Erreur de traitement CSV:', error);
        document.getElementById("fileStatus").innerHTML = 
          "‚ùå Erreur lors du traitement des donn√©es";
      }
    }

    function findProduct() {
      // Arr√™ter les scanners actifs
      if (window.isScanning) stopCamera();
      if (window.isEanScanning) stopEanScanner();
      
      const code = document.getElementById("barcodeInput").value.trim();
      if (!code) {
        alert("‚ö†Ô∏è Veuillez entrer un code EAN");
        return;
      }
      
      if (database.length === 0) {
        alert("‚ö†Ô∏è Veuillez d'abord charger un fichier CSV");
        return;
      }
      
      const result = database.find(row => row[COL_EAN] === code);
      const rd = document.getElementById("results");

      if (result) {
        currentProduct = result;
        rd.style.display = "block";
        rd.innerHTML = `
          <div class="item">
            <strong>‚úÖ Article trouv√© !</strong><br/><br/>
            <strong>R√©f :</strong> ${result[COL_REF] || 'N/A'}<br/>
            <strong>Code Article :</strong> ${result[COL_CODE] || 'N/A'}<br/>
            <strong>Marque :</strong> ${result[COL_MARQUE] || 'N/A'}<br/>
            <strong>Couleur :</strong> ${result[COL_COULEUR] || 'N/A'}<br/>
            <strong>Taille :</strong> ${result[COL_TAILLE] || 'N/A'}<br/>
            <strong>EAN :</strong> ${result[COL_EAN] || 'N/A'}<br/><br/>
            <button onclick='startQualityControl()'>üîç Commencer le contr√¥le qualit√©</button>
          </div>`;
      } else {
        rd.style.display = "block";
        rd.innerHTML = `
          <div class="item">
            <strong>‚ùå Aucun article trouv√©</strong><br/>
            Code EAN recherch√© : <strong>${code}</strong><br/>
            V√©rifiez le code ou la base de donn√©es.<br/><br/>
            <button onclick="startCamera()">üì∑ Essayer avec la cam√©ra</button>
          </div>`;
      }
      
      rd.scrollIntoView({ behavior: 'smooth' });
    }

    function showProductList() {
      // Arr√™ter les scanners actifs
      if (window.isScanning) stopCamera();
      if (window.isEanScanning) stopEanScanner();
      
      if (database.length === 0) {
        alert("‚ö†Ô∏è Veuillez d'abord charger un fichier CSV");
        return;
      }
      
      document.getElementById('productListContainer').style.display = 'block';
      document.getElementById('searchInput').value = '';
      displayProducts(database);
      
      document.getElementById('productListContainer').scrollIntoView({ behavior: 'smooth' });
      
      setTimeout(() => {
        document.getElementById('searchInput').focus();
      }, 300);
    }

    function hideProductList() {
      document.getElementById('productListContainer').style.display = 'none';
    }

    function displayProducts(products) {
      const productList = document.getElementById('productList');
      
      if (products.length === 0) {
        productList.innerHTML = '<div class="no-results">Aucun produit trouv√©</div>';
        return;
      }
      
      productList.innerHTML = products.slice(0, 100).map((item, index) => 
        `<div class="product-item" onclick="selectProduct(${database.indexOf(item)})">
          <div class="product-ref">${item[COL_REF] || 'N/A'}</div>
          <div class="product-details">
            ${item[COL_CODE] || 'N/A'} | ${item[COL_MARQUE] || 'N/A'} | 
            Taille: ${item[COL_TAILLE] || 'N/A'} | Couleur: ${item[COL_COULEUR] || 'N/A'}
          </div>
        </div>`
      ).join('');
      
      if (products.length > 100) {
        productList.innerHTML += '<div class="no-results">... et ' + (products.length - 100) + ' autres r√©sultats. Affinez votre recherche.</div>';
      }
    }

    function filterProducts() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      
      if (searchTerm === '') {
        displayProducts(database);
        return;
      }
      
      const filteredProducts = database.filter(item => {
        const ref = (item[COL_REF] || '').toLowerCase();
        const code = (item[COL_CODE] || '').toLowerCase();
        const marque = (item[COL_MARQUE] || '').toLowerCase();
        const couleur = (item[COL_COULEUR] || '').toLowerCase();
        const taille = (item[COL_TAILLE] || '').toLowerCase();
        const ean = (item[COL_EAN] || '').toLowerCase();
        
        return ref.includes(searchTerm) || 
               code.includes(searchTerm) || 
               marque.includes(searchTerm) || 
               couleur.includes(searchTerm) || 
               taille.includes(searchTerm) ||
               ean.includes(searchTerm);
      });
      
      displayProducts(filteredProducts);
    }

    function selectProduct(index) {
      const selectedItem = database[index];
      currentProduct = selectedItem;
      hideProductList();
      
      const rd = document.getElementById("results");
      rd.style.display = "block";
      rd.innerHTML = `
        <div class="item">
          <strong>‚úÖ Article s√©lectionn√© !</strong><br/><br/>
          <strong>R√©f :</strong> ${selectedItem[COL_REF] || 'N/A'}<br/>
          <strong>Code Article :</strong> ${selectedItem[COL_CODE] || 'N/A'}<br/>
          <strong>Marque :</strong> ${selectedItem[COL_MARQUE] || 'N/A'}<br/>
          <strong>Couleur :</strong> ${selectedItem[COL_COULEUR] || 'N/A'}<br/>
          <strong>Taille :</strong> ${selectedItem[COL_TAILLE] || 'N/A'}<br/>
          <strong>EAN :</strong> ${selectedItem[COL_EAN] || 'N/A'}<br/><br/>
          <button onclick='startQualityControl()'>üîç Commencer le contr√¥le qualit√©</button>
        </div>`;
      
      document.getElementById("barcodeInput").value = selectedItem[COL_EAN] || '';
      rd.scrollIntoView({ behavior: 'smooth' });
      
      if (navigator.vibrate) {
        navigator.vibrate(100);
      }
    }

    function startQualityControl() {
      // Arr√™ter les scanners actifs
      if (window.isScanning) stopCamera();
      if (window.isEanScanning) stopEanScanner();
      
      if (!currentProduct) return;

      // Masquer la section de r√©sultats
      document.getElementById("results").style.display = "none";

      // Afficher les informations du produit
      const productInfoHtml = `
        <h4>üì¶ Produit √† contr√¥ler</h4>
        <strong>R√©f :</strong> ${currentProduct[COL_REF] || 'N/A'} | 
        <strong>Code :</strong> ${currentProduct[COL_CODE] || 'N/A'} | 
        <strong>Marque :</strong> ${currentProduct[COL_MARQUE] || 'N/A'}<br/>
        <strong>Couleur :</strong> ${currentProduct[COL_COULEUR] || 'N/A'} | 
        <strong>Taille :</strong> ${currentProduct[COL_TAILLE] || 'N/A'} | 
        <strong>EAN :</strong> ${currentProduct[COL_EAN] || 'N/A'}
      `;
      
      document.getElementById("selectedProductInfo").innerHTML = productInfoHtml;

      // Afficher la section de contr√¥le qualit√© carton
      document.getElementById("step3").classList.remove("hidden");
      document.getElementById("step3").classList.add("active");
      document.getElementById("step2").classList.remove("active");
      document.getElementById("step2").classList.add("completed");

      // R√©initialiser les contr√¥les
      resetQualityControls();

      // Scroll vers la section de contr√¥le
      document.getElementById("step3").scrollIntoView({ behavior: 'smooth' });
    }

    function resetQualityControls() {
      // R√©initialiser tous les boutons radio
      document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.checked = false;
      });

      // Vider tous les commentaires
      document.querySelectorAll('.comment-area').forEach(textarea => {
        textarea.value = '';
      });

      // Vider tous les inputs de fichiers
      document.querySelectorAll('input[type="file"]').forEach(fileInput => {
        fileInput.value = '';
      });

      // R√©initialiser les photos
      criterionPhotos = {};
      initializePhotoContainers();
      
      // Vider tous les conteneurs de photos
      document.querySelectorAll('.photo-preview').forEach(container => {
        container.innerHTML = '';
      });

      // R√©initialiser les objets des r√©sultats
      packageQualityResults = {};
      productQualityResults = {};

      // D√©sactiver les boutons de validation
      document.getElementById('packageValidateButton').disabled = true;
      if (document.getElementById('productValidateButton')) {
        document.getElementById('productValidateButton').disabled = true;
      }
    }

    function updatePackageQualityStatus() {
      // V√©rifier si tous les crit√®res du carton sont remplis
      const shippingMark = document.querySelector('input[name="shipping_mark"]:checked');
      const packageCondition = document.querySelector('input[name="package_condition"]:checked');
      const warrantySeal = document.querySelector('input[name="warranty_seal"]:checked');

      // Activer le bouton si tous les crit√®res sont √©valu√©s
      const allChecked = shippingMark && packageCondition && warrantySeal;
      document.getElementById('packageValidateButton').disabled = !allChecked;

      // Mettre √† jour l'objet des r√©sultats du carton
      if (allChecked) {
        packageQualityResults = {
          shipping_mark: {
            status: shippingMark.value,
            comment: document.getElementById('comment_shipping_mark').value,
            photos: criterionPhotos['shipping_mark'] || []
          },
          package_condition: {
            status: packageCondition.value,
            comment: document.getElementById('comment_package_condition').value,
            photos: criterionPhotos['package_condition'] || []
          },
          warranty_seal: {
            status: warrantySeal.value,
            comment: document.getElementById('comment_warranty_seal').value,
            photos: criterionPhotos['warranty_seal'] || []
          }
        };
      }
    }

    function updateProductQualityStatus() {
      // V√©rifier si tous les crit√®res du produit sont remplis
      const zipTest = document.querySelector('input[name="zip_test"]:checked');
      const buttonCheck = document.querySelector('input[name="button_check"]:checked');
      const colorCheck = document.querySelector('input[name="color_check"]:checked');
      const finishingCheck = document.querySelector('input[name="finishing_check"]:checked');

      // Activer le bouton si tous les crit√®res sont √©valu√©s
      const allChecked = zipTest && buttonCheck && colorCheck && finishingCheck;
      document.getElementById('productValidateButton').disabled = !allChecked;

      // Mettre √† jour l'objet des r√©sultats du produit
      if (allChecked) {
        productQualityResults = {
          zip_test: {
            status: zipTest.value,
            comment: document.getElementById('comment_zip_test').value,
            photos: criterionPhotos['zip_test'] || []
          },
          button_check: {
            status: buttonCheck.value,
            comment: document.getElementById('comment_button_check').value,
            photos: criterionPhotos['button_check'] || []
          },
          color_check: {
            status: colorCheck.value,
            comment: document.getElementById('comment_color_check').value,
            photos: criterionPhotos['color_check'] || []
          },
          finishing_check: {
            status: finishingCheck.value,
            comment: document.getElementById('comment_finishing_check').value,
            photos: criterionPhotos['finishing_check'] || []
          }
        };
      }
    }

    function proceedToProductControl() {
      // Arr√™ter les scanners actifs
      if (window.isScanning) stopCamera();
      if (window.isEanScanning) stopEanScanner();
      
      updatePackageQualityStatus();
      
      // Passer √† l'√©tape 4 (contr√¥le produit)
      document.getElementById("step3").classList.remove("active");
      document.getElementById("step3").classList.add("completed");
      
      // Copier les informations du produit dans la section produit
      const productInfoHtml = `
        <h4>üëï Contr√¥le du produit</h4>
        <strong>R√©f :</strong> ${currentProduct[COL_REF] || 'N/A'} | 
        <strong>Code :</strong> ${currentProduct[COL_CODE] || 'N/A'} | 
        <strong>Marque :</strong> ${currentProduct[COL_MARQUE] || 'N/A'}<br/>
        <strong>Couleur :</strong> ${currentProduct[COL_COULEUR] || 'N/A'} | 
        <strong>Taille :</strong> ${currentProduct[COL_TAILLE] || 'N/A'} | 
        <strong>EAN :</strong> ${currentProduct[COL_EAN] || 'N/A'}
      `;
      
      document.getElementById("productControlInfo").innerHTML = productInfoHtml;
      
      document.getElementById("step4").classList.remove("hidden");
      document.getElementById("step4").classList.add("active");

      // Scroll vers la section de contr√¥le produit
      document.getElementById("step4").scrollIntoView({ behavior: 'smooth' });
    }

    function goBackToPackageControl() {
      // Retourner √† l'√©tape 3 (contr√¥le carton)
      document.getElementById("step4").classList.remove("active");
      document.getElementById("step4").classList.add("hidden");
      
      document.getElementById("step3").classList.add("active");
      document.getElementById("step3").classList.remove("completed");

      // Scroll vers la section de contr√¥le carton
      document.getElementById("step3").scrollIntoView({ behavior: 'smooth' });
    }

    function proceedToEanControl() {
      // Arr√™ter les scanners actifs
      if (window.isScanning) stopCamera();
      if (window.isEanScanning) stopEanScanner();
      
      updateProductQualityStatus();
      
      if (!currentProduct || !currentProduct[COL_REF]) {
        alert("‚ö†Ô∏è Impossible de r√©cup√©rer la r√©f√©rence du produit");
        return;
      }

      currentReference = currentProduct[COL_REF];
      
      // Trouver tous les EAN de cette r√©f√©rence
      referenceEanList = database.filter(item => item[COL_REF] === currentReference);
      checkedEans.clear();
      nonTestedEans.clear(); // Reset des EAN non test√©s

      if (referenceEanList.length === 0) {
        alert("‚ö†Ô∏è Aucun EAN trouv√© pour cette r√©f√©rence");
        return;
      }

      // Passer √† l'√©tape 5 (contr√¥le EAN)
      document.getElementById("step4").classList.remove("active");
      document.getElementById("step4").classList.add("completed");
      
      // Afficher les informations de la r√©f√©rence
      const eanInfoHtml = `
        <h4>üìã Contr√¥le des EAN</h4>
        <strong>R√©f√©rence :</strong> ${currentReference}<br/>
        <strong>Nombre d'EAN √† contr√¥ler :</strong> ${referenceEanList.length}<br/>
        <small>V√©rifiez que tous les codes EAN de cette r√©f√©rence sont pr√©sents physiquement</small>
      `;
      
      document.getElementById("eanControlInfo").innerHTML = eanInfoHtml;
      
      document.getElementById("step5").classList.remove("hidden");
      document.getElementById("step5").classList.add("active");

      // Initialiser la liste des EAN
      displayEanList();
      updateEanProgress();

      // Scroll vers la section de contr√¥le EAN
      document.getElementById("step5").scrollIntoView({ behavior: 'smooth' });
    }

    function displayEanList() {
      const eanList = document.getElementById('eanList');
      
      eanList.innerHTML = referenceEanList.map((item, index) => {
        const isChecked = checkedEans.has(item[COL_EAN]);
        const isNonTested = nonTestedEans.has(item[COL_EAN]);
        
        let statusClass = '';
        let statusText = '';
        let statusBadgeClass = '';
        let actionButton = '';
        
        if (isChecked) {
          statusClass = 'checked';
          statusText = 'Verifie ‚úÖ';
          statusBadgeClass = 'found';
          actionButton = `<button onclick="resetEanStatus('${item[COL_EAN]}')" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; font-size: 0.8em; margin-left: 10px;">üîÑ Reset</button>`;
        } else if (isNonTested) {
          statusClass = 'non-tested';
          statusText = 'Non test√© ‚è≠Ô∏è';
          statusBadgeClass = 'non-tested';
          actionButton = `<button onclick="resetEanStatus('${item[COL_EAN]}')" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; font-size: 0.8em; margin-left: 10px;">üîÑ Reset</button>`;
        } else {
          statusClass = '';
          statusText = 'En attente ‚è≥';
          statusBadgeClass = 'pending';
          actionButton = `<button onclick="markAsNonTested('${item[COL_EAN]}')" style="background: #ffc107; color: #000; border: none; padding: 5px 10px; border-radius: 3px; font-size: 0.8em; margin-left: 10px;">‚è≠Ô∏è Non test√©</button>`;
        }
        
        return `
          <div class="ean-item ${statusClass}" id="ean-item-${index}">
            <div class="ean-details">
              <div class="ean-code">${item[COL_EAN] || 'N/A'}</div>
              <div class="ean-info">
                ${item[COL_CODE] || 'N/A'} | 
                Taille: ${item[COL_TAILLE] || 'N/A'} | 
                Couleur: ${item[COL_COULEUR] || 'N/A'}
              </div>
            </div>
            <div style="display: flex; align-items: center;">
              <div class="ean-status ${statusBadgeClass}">${statusText}</div>
              ${actionButton}
            </div>
          </div>
        `;
      }).join('');
    }

    function updateEanProgress() {
      const total = referenceEanList.length;
      const checked = checkedEans.size;
      const nonTested = nonTestedEans.size;
      const processed = checked + nonTested; // Total des EAN trait√©s (trouv√©s + non test√©s)
      const percentage = total > 0 ? (processed / total) * 100 : 0;

      document.getElementById('progressFill').style.width = percentage + '%';
      document.getElementById('progressText').textContent = `${checked} verifies + ${nonTested} non testes = ${processed} / ${total} EAN traites`;

      // Activer le bouton de finalisation si tous les EAN sont trait√©s (trouv√©s ou non test√©s)
      document.getElementById('completeValidateButton').disabled = processed < total;

      // Afficher un r√©sum√© si tous les EAN sont trait√©s
      if (processed === total && total > 0) {
        showEanValidationResult();
      }
    }

    // Fonction pour marquer un EAN comme non test√©
    function markAsNonTested(eanCode) {
      if (checkedEans.has(eanCode)) {
        // Si d√©j√† trouv√©, ne rien faire
        return;
      }
      
      nonTestedEans.add(eanCode);
      displayEanList();
      updateEanProgress();
      
      // Vibration de confirmation si support√©e
      if (navigator.vibrate) {
        navigator.vibrate(100);
      }
    }

    // Fonction pour remettre un EAN en attente (reset)
    function resetEanStatus(eanCode) {
      if (confirm("üîÑ Remettre cet EAN en attente ?\n\nIl redeviendra disponible pour √™tre scann√© ou marqu√© comme non test√©.")) {
        checkedEans.delete(eanCode);
        nonTestedEans.delete(eanCode);
        displayEanList();
        updateEanProgress();
        
        // Vibration de confirmation si support√©e
        if (navigator.vibrate) {
          navigator.vibrate(100);
        }
      }
    }

    function showEanValidationResult() {
      const resultDiv = document.getElementById('eanValidationResult');
      const total = referenceEanList.length;
      const checked = checkedEans.size;
      const nonTested = nonTestedEans.size;
      
      let statusClass = 'success';
      let statusIcon = '‚úÖ';
      let statusTitle = 'Contr√¥le EAN termin√©';
      
      if (nonTested > 0) {
        statusClass = 'warning';
        statusIcon = '‚ö†Ô∏è';
        statusTitle = 'Contr√¥le EAN termin√© avec r√©serves';
      }
      
      resultDiv.innerHTML = `
        <div class="validation-summary ${statusClass}">
          <h4>${statusIcon} ${statusTitle}</h4>
          <p>R√©f√©rence <strong>${currentReference}</strong> : ${total} EAN au total</p>
          <ul style="margin: 10px 0; padding-left: 20px;">
            <li><strong>${checked} EAN v√©rifi√©s</strong> ‚úÖ</li>
            ${nonTested > 0 ? `<li><strong>${nonTested} EAN non test√©s</strong> ‚è≠Ô∏è</li>` : ''}
          </ul>
          <p>Vous pouvez maintenant finaliser le contr√¥le complet.</p>
        </div>
      `;
      resultDiv.style.display = 'block';
    }

    function startEanScanner() {
      const video = document.getElementById('eanVideo');
      const scanButton = document.getElementById('eanScanButton');
      const stopButton = document.getElementById('eanStopButton');
      
      try {
        // Arr√™ter toute session pr√©c√©dente
        if (eanCodeReader) {
          eanCodeReader.reset();
        }
        
        eanCodeReader = new window.BrowserMultiFormatReader();
        const constraints = {
          video: {
            facingMode: 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        };
        
        eanCodeReader.decodeFromConstraints(constraints, video, (result, err) => {
          if (result && window.isEanScanning) {
            document.getElementById("eanInput").value = result.text;
            checkEanForReference();
            if (navigator.vibrate) {
              navigator.vibrate(200);
            }
          }
        }).then(() => {
          window.isEanScanning = true;
          video.style.display = 'block';
          scanButton.style.display = 'none';
          stopButton.style.display = 'inline-block';
          document.getElementById('eanScannerContainer').style.display = 'block';
        }).catch(err => {
          console.error('Erreur cam√©ra EAN:', err);
          alert('Impossible d\'acc√©der √† la cam√©ra pour le scan EAN. V√©rifiez les permissions.');
          resetEanCameraButtons();
        });
        
      } catch (err) {
        console.error('Erreur initialisation scanner EAN:', err);
        alert('Erreur lors de l\'initialisation du scanner EAN.');
        resetEanCameraButtons();
      }
    }

    function stopEanScanner() {
      window.isEanScanning = false;
      
      // Arr√™ter le flux vid√©o EAN
      const eanVideo = document.getElementById('eanVideo');
      if (eanVideo && eanVideo.srcObject) {
        const stream = eanVideo.srcObject;
        if (stream) {
          stream.getTracks().forEach(track => {
            track.stop();
            console.log('Track EAN arr√™t√©:', track.kind);
          });
          eanVideo.srcObject = null;
        }
      }
      
      // Arr√™ter le code reader EAN
      if (eanCodeReader) {
        try {
          eanCodeReader.reset();
        } catch (e) {
          console.log('Erreur lors de l\'arr√™t de la cam√©ra EAN:', e);
        }
        eanCodeReader = null;
      }
      
      resetEanCameraButtons();
    }

    function resetEanCameraButtons() {
      const eanVideo = document.getElementById('eanVideo');
      if (eanVideo) {
        eanVideo.style.display = 'none';
        // S'assurer que le flux est bien coup√©
        if (eanVideo.srcObject) {
          eanVideo.srcObject = null;
        }
      }
      
      document.getElementById('eanScanButton').style.display = 'inline-block';
      document.getElementById('eanStopButton').style.display = 'none';
      document.getElementById('eanScannerContainer').style.display = 'none';
    }

    function checkEanForReference() {
      const scannedEan = document.getElementById("eanInput").value.trim();
      
      if (!scannedEan) {
        alert("‚ö†Ô∏è Veuillez saisir ou scanner un code EAN");
        return;
      }

      // V√©rifier si cet EAN appartient √† la r√©f√©rence actuelle
      const matchingItem = referenceEanList.find(item => item[COL_EAN] === scannedEan);
      
      if (matchingItem) {
        if (checkedEans.has(scannedEan)) {
          alert("‚ÑπÔ∏è Cet EAN a d√©j√† √©t√© v√©rifi√©");
        } else {
          // Si l'EAN √©tait marqu√© comme non test√©, le retirer de cette liste
          if (nonTestedEans.has(scannedEan)) {
            nonTestedEans.delete(scannedEan);
          }
          
          checkedEans.add(scannedEan);
          displayEanList();
          updateEanProgress();
          
          // Feedback positif
          if (navigator.vibrate) {
            navigator.vibrate([100, 50, 100]);
          }
          
          // Animation de succ√®s
          const itemIndex = referenceEanList.findIndex(item => item[COL_EAN] === scannedEan);
          const itemElement = document.getElementById(`ean-item-${itemIndex}`);
          if (itemElement) {
            itemElement.style.transform = 'scale(1.05)';
            setTimeout(() => {
              itemElement.style.transform = 'scale(1)';
            }, 200);
          }
        }
      } else {
        // V√©rifier si cet EAN existe dans la base mais pour une autre r√©f√©rence
        const otherItem = database.find(item => item[COL_EAN] === scannedEan);
        
        if (otherItem) {
          alert(`‚ùå Cet EAN appartient √† une autre r√©f√©rence :\n${otherItem[COL_REF]}\n\nR√©f√©rence attendue : ${currentReference}`);
        } else {
          alert("‚ùå Code EAN non trouv√© dans la base de donn√©es");
        }
      }
      
      // Vider le champ de saisie
      document.getElementById("eanInput").value = "";
    }

    function goBackToProductControl() {
      // Retourner √† l'√©tape 4 (contr√¥le produit)
      document.getElementById("step5").classList.remove("active");
      document.getElementById("step5").classList.add("hidden");
      
      document.getElementById("step4").classList.add("active");
      document.getElementById("step4").classList.remove("completed");

      // Arr√™ter le scanner EAN s'il est en cours
      stopEanScanner();

      // Scroll vers la section de contr√¥le produit
      document.getElementById("step4").scrollIntoView({ behavior: 'smooth' });
    }

    function generateQualityReport() {
      // Arr√™ter toutes les cam√©ras en cours d'utilisation
      if (window.isScanning) stopCamera();
      if (window.isEanScanning) stopEanScanner();
      
      if (!currentProduct) {
        alert("Aucun produit selectionne pour generer le rapport");
        return;
      }

      // V√©rifier qu'au moins un contr√¥le a √©t√© effectu√©
      const hasPackageControl = Object.keys(packageQualityResults).length > 0;
      const hasProductControl = Object.keys(productQualityResults).length > 0;
      const hasEanControl = currentReference && referenceEanList.length > 0;

      if (!hasPackageControl && !hasProductControl && !hasEanControl) {
        alert("Aucun controle effectue pour generer un rapport.\n\nCommencez au moins un controle (carton, produit ou EAN) avant de generer le rapport.");
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      let yPosition = 20;
      const lineHeight = 8;
      const sectionSpacing = 15;
      const pageHeight = 280;
      
      // Couleurs
      const colors = {
        primary: [102, 126, 234], // Bleu principal
        secondary: [118, 75, 162], // Violet
        success: [40, 167, 69], // Vert
        danger: [220, 53, 69], // Rouge
        warning: [255, 193, 7], // Jaune
        info: [23, 162, 184], // Cyan
        light: [248, 249, 250], // Gris tr√®s clair
        lightBlue: [224, 240, 255] // Bleu tr√®s clair
      };
      
      // En-t√™te du document avec fond color√©
      doc.setFillColor(colors.primary[0], colors.primary[1], colors.primary[2]);
      doc.rect(10, 10, 190, 25, 'F');
      
      doc.setTextColor(255, 255, 255); // Texte blanc
      doc.setFontSize(20);
      doc.setFont(undefined, 'bold');
      doc.text('RAPPORT DE CONTROLE QUALITE', 20, 28);
      
      // Reset couleur texte
      doc.setTextColor(0, 0, 0);
      
      yPosition = 45;
      doc.setFontSize(12);
      doc.setFont(undefined, 'normal');
      doc.text('Date de generation: ' + new Date().toLocaleString('fr-FR'), 20, yPosition);
      doc.text('Reference du rapport: QC-' + Date.now(), 120, yPosition);
      
      yPosition += sectionSpacing + 5;
      
      // Section 1: Informations du produit
      doc.setFillColor(colors.lightBlue[0], colors.lightBlue[1], colors.lightBlue[2]);
      doc.rect(15, yPosition - 8, 180, 15, 'F');
      
      doc.setFontSize(16);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(colors.primary[0], colors.primary[1], colors.primary[2]);
      doc.text('INFORMATIONS PRODUIT', 20, yPosition);
      doc.setTextColor(0, 0, 0);
      
      yPosition += 12;
      doc.setFontSize(11);
      doc.setFont(undefined, 'normal');
      
      const productInfo = [
        'Reference: ' + (currentProduct[COL_REF] || 'N/A'),
        'Code Article: ' + (currentProduct[COL_CODE] || 'N/A'),
        'Marque: ' + (currentProduct[COL_MARQUE] || 'N/A'),
        'Couleur: ' + (currentProduct[COL_COULEUR] || 'N/A'),
        'Taille: ' + (currentProduct[COL_TAILLE] || 'N/A'),
        'EAN: ' + (currentProduct[COL_EAN] || 'N/A')
      ];
      
      productInfo.forEach(info => {
        doc.text(info, 20, yPosition);
        yPosition += lineHeight;
      });
      
      yPosition += sectionSpacing;
      
      // V√©rifier si nouvelle page n√©cessaire
      if (yPosition > pageHeight - 50) {
        doc.addPage();
        yPosition = 20;
      }
      
      // Section 2: Contr√¥le Qualit√© - Carton
      doc.setFillColor(colors.success[0], colors.success[1], colors.success[2]);
      doc.rect(15, yPosition - 8, 180, 15, 'F');
      
      doc.setFontSize(16);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(255, 255, 255);
      doc.text('CONTROLE QUALITE - CARTON', 20, yPosition);
      doc.setTextColor(0, 0, 0);
      
      yPosition += 12;
      doc.setFontSize(11);
      doc.setFont(undefined, 'normal');
      
      if (hasPackageControl) {
        const packageCriteria = [
          { key: 'shipping_mark', label: 'Shipping Mark' },
          { key: 'package_condition', label: 'Etat du colis' },
          { key: 'warranty_seal', label: 'Bande de garantie' }
        ];
        
        packageCriteria.forEach(criterion => {
          if (packageQualityResults[criterion.key]) {
            const result = packageQualityResults[criterion.key];
            const isOk = result.status === 'ok';
            
            // Couleur du statut
            doc.setTextColor(isOk ? colors.success[0] : colors.danger[0], 
                           isOk ? colors.success[1] : colors.danger[1], 
                           isOk ? colors.success[2] : colors.danger[2]);
            const status = isOk ? '[OK]' : '[PAS OK]';
            
            doc.setTextColor(0, 0, 0);
            doc.text(criterion.label + ': ', 20, yPosition);
            doc.setTextColor(isOk ? colors.success[0] : colors.danger[0], 
                           isOk ? colors.success[1] : colors.danger[1], 
                           isOk ? colors.success[2] : colors.danger[2]);
            doc.text(status, 80, yPosition);
            doc.setTextColor(0, 0, 0);
            yPosition += lineHeight;
            
            if (result.comment && result.comment.trim()) {
              doc.setFontSize(9);
              doc.setTextColor(100, 100, 100);
              const comments = doc.splitTextToSize('  -> ' + result.comment, 165);
              comments.forEach(line => {
                doc.text(line, 25, yPosition);
                yPosition += 6;
              });
              doc.setTextColor(0, 0, 0);
              doc.setFontSize(11);
            }
            
            if (result.photos && result.photos.length > 0) {
              doc.setFontSize(9);
              doc.setTextColor(colors.info[0], colors.info[1], colors.info[2]);
              doc.text('  -> ' + result.photos.length + ' photo(s) documentaire(s)', 25, yPosition);
              yPosition += 6;
              doc.setTextColor(0, 0, 0);
              doc.setFontSize(11);
            }
            
            yPosition += 3; // Espacement entre crit√®res
          }
        });
      } else {
        doc.setTextColor(colors.danger[0], colors.danger[1], colors.danger[2]);
        doc.text('Controle carton non effectue', 20, yPosition);
        doc.setTextColor(0, 0, 0);
        yPosition += lineHeight;
      }
      
      yPosition += sectionSpacing;
      
      // V√©rifier si nouvelle page n√©cessaire
      if (yPosition > pageHeight - 50) {
        doc.addPage();
        yPosition = 20;
      }
      
      // Section 3: Contr√¥le Qualit√© - Produit
      doc.setFillColor(colors.info[0], colors.info[1], colors.info[2]);
      doc.rect(15, yPosition - 8, 180, 15, 'F');
      
      doc.setFontSize(16);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(255, 255, 255);
      doc.text('CONTROLE QUALITE - PRODUIT', 20, yPosition);
      doc.setTextColor(0, 0, 0);
      
      yPosition += 12;
      doc.setFontSize(11);
      doc.setFont(undefined, 'normal');
      
      if (hasProductControl) {
        const productCriteria = [
          { key: 'zip_test', label: 'Verification zip' },
          { key: 'button_check', label: 'Verification boutonnage' },
          { key: 'color_check', label: 'Verification coloris' },
          { key: 'finishing_check', label: 'Verification finition/coutures' }
        ];
        
        productCriteria.forEach(criterion => {
          if (productQualityResults[criterion.key]) {
            const result = productQualityResults[criterion.key];
            let status, color;
            
            if (result.status === 'ok') {
              status = '[OK]';
              color = colors.success;
            } else if (result.status === 'not_ok') {
              status = '[PAS OK]';
              color = colors.danger;
            } else {
              status = '[NON APPLICABLE]';
              color = colors.warning;
            }
            
            doc.setTextColor(0, 0, 0);
            doc.text(criterion.label + ': ', 20, yPosition);
            doc.setTextColor(color[0], color[1], color[2]);
            doc.text(status, 80, yPosition);
            doc.setTextColor(0, 0, 0);
            yPosition += lineHeight;
            
            if (result.comment && result.comment.trim()) {
              doc.setFontSize(9);
              doc.setTextColor(100, 100, 100);
              const comments = doc.splitTextToSize('  -> ' + result.comment, 165);
              comments.forEach(line => {
                doc.text(line, 25, yPosition);
                yPosition += 6;
              });
              doc.setTextColor(0, 0, 0);
              doc.setFontSize(11);
            }
            
            if (result.photos && result.photos.length > 0) {
              doc.setFontSize(9);
              doc.setTextColor(colors.info[0], colors.info[1], colors.info[2]);
              doc.text('  -> ' + result.photos.length + ' photo(s) documentaire(s)', 25, yPosition);
              yPosition += 6;
              doc.setTextColor(0, 0, 0);
              doc.setFontSize(11);
            }
            
            yPosition += 3; // Espacement entre crit√®res
          }
        });
      } else {
        doc.setTextColor(colors.danger[0], colors.danger[1], colors.danger[2]);
        doc.text('Controle produit non effectue', 20, yPosition);
        doc.setTextColor(0, 0, 0);
        yPosition += lineHeight;
      }
      
      yPosition += sectionSpacing;
      
      // V√©rifier si nouvelle page n√©cessaire
      if (yPosition > pageHeight - 80) {
        doc.addPage();
        yPosition = 20;
      }
      
      // Section 4: Contr√¥le EAN
      doc.setFillColor(colors.warning[0], colors.warning[1], colors.warning[2]);
      doc.rect(15, yPosition - 8, 180, 15, 'F');
      
      doc.setFontSize(16);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(0, 0, 0);
      doc.text('CONTROLE EAN - REFERENCE', 20, yPosition);
      
      yPosition += 12;
      doc.setFontSize(11);
      doc.setFont(undefined, 'normal');
      
      if (hasEanControl) {
        doc.text('Reference controlee: ' + currentReference, 20, yPosition);
        yPosition += lineHeight;
        
        const totalEan = referenceEanList.length;
        const foundEan = checkedEans.size;
        const nonTestedEan = nonTestedEans.size;
        const processedEan = foundEan + nonTestedEan;
        
        doc.text('Total EAN de la reference: ' + totalEan, 20, yPosition);
        yPosition += lineHeight;
        
        doc.setTextColor(colors.success[0], colors.success[1], colors.success[2]);
        doc.text('EAN verifies: ' + foundEan, 20, yPosition);
        yPosition += lineHeight;
        
        doc.setTextColor(colors.warning[0], colors.warning[1], colors.warning[2]);
        doc.text('EAN non testes: ' + nonTestedEan, 20, yPosition);
        yPosition += lineHeight;
        
        doc.setTextColor(0, 0, 0);
        doc.text('Progression: ' + processedEan + '/' + totalEan + ' (' + (totalEan > 0 ? ((processedEan/totalEan)*100).toFixed(1) : 0) + '%)', 20, yPosition);
        yPosition += lineHeight + 5;
        
        // D√©tail des EAN
        doc.setFontSize(10);
        doc.text('Detail par EAN:', 20, yPosition);
        yPosition += lineHeight;
        
        referenceEanList.forEach(item => {
          const isFound = checkedEans.has(item[COL_EAN]);
          const isNonTested = nonTestedEans.has(item[COL_EAN]);
          
          let status, color;
          if (isFound) {
            status = '[VERIFIE]';
            color = colors.success;
          } else if (isNonTested) {
            status = '[NON TESTE]';
            color = colors.warning;
          } else {
            status = '[EN ATTENTE]';
            color = [100, 100, 100]; // Gris
          }
          
          doc.setTextColor(0, 0, 0);
          doc.text(item[COL_EAN] + ' (' + item[COL_TAILLE] + ') ', 25, yPosition);
          doc.setTextColor(color[0], color[1], color[2]);
          doc.text(status, 130, yPosition);
          doc.setTextColor(0, 0, 0);
          yPosition += 6;
          
          // V√©rifier si nouvelle page n√©cessaire
          if (yPosition > pageHeight - 20) {
            doc.addPage();
            yPosition = 20;
          }
        });
      } else {
        doc.setTextColor(colors.danger[0], colors.danger[1], colors.danger[2]);
        doc.text('Controle EAN non effectue', 20, yPosition);
        doc.setTextColor(0, 0, 0);
        yPosition += lineHeight;
      }
      
      yPosition += sectionSpacing;
      
      // Section 5: Photos du contr√¥le
      const totalPhotos = Object.values(criterionPhotos).reduce((total, photos) => total + photos.length, 0);
      
      if (totalPhotos > 0) {
        // V√©rifier si nouvelle page n√©cessaire pour les photos
        if (yPosition > pageHeight - 100) {
          doc.addPage();
          yPosition = 20;
        }
        
        doc.setFillColor(colors.secondary[0], colors.secondary[1], colors.secondary[2]);
        doc.rect(15, yPosition - 8, 180, 15, 'F');
        
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(255, 255, 255);
        doc.text('PHOTOS DU CONTROLE', 20, yPosition);
        doc.setTextColor(0, 0, 0);
        
        yPosition += 15;
        
        const photoWidth = 70;
        const photoHeight = 52;
        const photosPerRow = 2;
        const marginBetweenPhotos = 10;
        
        let photoIndex = 0;
        
        Object.entries(criterionPhotos).forEach(([criterionName, photos]) => {
          if (photos.length > 0) {
            // Calculer l'espace n√©cessaire pour ce crit√®re
            const photosForThisCriterion = photos.length;
            const rowsNeeded = Math.ceil(photosForThisCriterion / photosPerRow);
            const spaceNeeded = 15 + (rowsNeeded * (photoHeight + 20)); // Titre + photos
            
            // V√©rifier si on a assez de place pour le titre ET au moins une ligne de photos
            if (yPosition + spaceNeeded > pageHeight - 20) {
              doc.addPage();
              yPosition = 20;
              photoIndex = 0; // Reset index photos pour nouvelle page
            }
            
            // Titre du crit√®re
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(colors.primary[0], colors.primary[1], colors.primary[2]);
            
            // Convertir le nom du crit√®re en fran√ßais
            const criterionLabels = {
              'shipping_mark': 'Shipping Mark',
              'package_condition': 'Etat du colis',
              'warranty_seal': 'Bande de garantie',
              'zip_test': 'Verification zip',
              'button_check': 'Verification boutonnage',
              'color_check': 'Verification coloris',
              'finishing_check': 'Verification finition/coutures'
            };
            
            const criterionLabel = criterionLabels[criterionName] || criterionName;
            doc.text(criterionLabel + ' (' + photos.length + ' photo' + (photos.length > 1 ? 's' : '') + ')', 20, yPosition);
            doc.setTextColor(0, 0, 0);
            yPosition += 10;
            
            // Sauvegarder la position de d√©part pour ce crit√®re
            const startYForCriterion = yPosition;
            let maxYForCriterion = yPosition;
            
            photos.forEach((photo, index) => {
              const row = Math.floor(index / photosPerRow);
              const col = index % photosPerRow;
              
              const x = 20 + col * (photoWidth + marginBetweenPhotos);
              const y = startYForCriterion + row * (photoHeight + 20);
              
              // V√©rifier si cette photo d√©passe la page
              if (y + photoHeight > pageHeight - 10) {
                // Ajouter une nouvelle page et continuer
                doc.addPage();
                yPosition = 20;
                startYForCriterion = yPosition;
                
                // Recalculer la position pour la nouvelle page
                const newRow = Math.floor(index / photosPerRow) - Math.floor(photos.findIndex(p => photos.indexOf(p) === index && y + photoHeight > pageHeight - 10) / photosPerRow);
                const newY = startYForCriterion + newRow * (photoHeight + 20);
                
                try {
                  doc.addImage(photo.data, 'JPEG', x, newY, photoWidth, photoHeight);
                  doc.setFontSize(8);
                  doc.setTextColor(100, 100, 100);
                  doc.text(photo.timestamp, x, newY + photoHeight + 8);
                  doc.setTextColor(0, 0, 0);
                  maxYForCriterion = Math.max(maxYForCriterion, newY + photoHeight + 15);
                } catch (e) {
                  console.error('Erreur lors de l\'ajout de l\'image:', e);
                  doc.setFontSize(9);
                  doc.text('[Image non disponible: ' + photo.name + ']', x, newY + 20);
                  maxYForCriterion = Math.max(maxYForCriterion, newY + 30);
                }
              } else {
                try {
                  doc.addImage(photo.data, 'JPEG', x, y, photoWidth, photoHeight);
                  doc.setFontSize(8);
                  doc.setTextColor(100, 100, 100);
                  doc.text(photo.timestamp, x, y + photoHeight + 8);
                  doc.setTextColor(0, 0, 0);
                  maxYForCriterion = Math.max(maxYForCriterion, y + photoHeight + 15);
                } catch (e) {
                  console.error('Erreur lors de l\'ajout de l\'image:', e);
                  doc.setFontSize(9);
                  doc.text('[Image non disponible: ' + photo.name + ']', x, y + 20);
                  maxYForCriterion = Math.max(maxYForCriterion, y + 30);
                }
              }
            });
            
            // Ajuster yPosition pour le prochain crit√®re
            yPosition = maxYForCriterion + 10;
          }
        });
      }
      
      // Section 6: R√©sum√© et conclusion
      if (yPosition > pageHeight - 80) {
        doc.addPage();
        yPosition = 20;
      }
      
      yPosition += sectionSpacing;
      
      // Calcul des statistiques finales
      const packageIssues = Object.values(packageQualityResults).filter(result => result.status === 'not_ok').length;
      const productIssues = Object.values(productQualityResults).filter(result => result.status === 'not_ok').length;
      const totalQualityIssues = packageIssues + productIssues;
      
      const qualityStatus = totalQualityIssues === 0 ? 'CONFORME' : 'NON CONFORME';
      const eanCompleteness = (hasEanControl && nonTestedEans.size === 0) ? 'COMPLET' : hasEanControl ? 'PARTIEL' : 'NON EFFECTUE';
      
      // En-t√™te r√©sum√© avec couleur selon le statut
      const resumeColor = totalQualityIssues === 0 ? colors.success : colors.danger;
      doc.setFillColor(resumeColor[0], resumeColor[1], resumeColor[2]);
      doc.rect(15, yPosition - 8, 180, 15, 'F');
      
      doc.setFontSize(16);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(255, 255, 255);
      doc.text('RESUME DU CONTROLE', 20, yPosition);
      doc.setTextColor(0, 0, 0);
      
      yPosition += 12;
      doc.setFontSize(11);
      doc.setFont(undefined, 'normal');
      
      // Statut qualit√© avec couleur
      doc.setTextColor(totalQualityIssues === 0 ? colors.success[0] : colors.danger[0],
                     totalQualityIssues === 0 ? colors.success[1] : colors.danger[1],
                     totalQualityIssues === 0 ? colors.success[2] : colors.danger[2]);
      doc.text('Statut qualite: ' + qualityStatus, 20, yPosition);
      yPosition += lineHeight;
      
      doc.setTextColor(0, 0, 0);
      doc.text('Problemes detectes: ' + totalQualityIssues + ' (Carton: ' + packageIssues + ', Produit: ' + productIssues + ')', 20, yPosition);
      yPosition += lineHeight;
      doc.text('Controle EAN: ' + eanCompleteness, 20, yPosition);
      yPosition += lineHeight;
      doc.text('Photos documentaires: ' + totalPhotos, 20, yPosition);
      yPosition += lineHeight;
      
      // Statut du contr√¥le
      let controlStatus = 'PARTIEL';
      if (hasPackageControl && hasProductControl && hasEanControl) {
        controlStatus = 'COMPLET';
      }
      doc.text('Controle effectue: ' + controlStatus, 20, yPosition);
      yPosition += sectionSpacing;
      
      // Conclusion avec couleur
      doc.setFontSize(12);
      doc.setFont(undefined, 'bold');
      if (totalQualityIssues === 0 && (!hasEanControl || nonTestedEans.size === 0)) {
        doc.setTextColor(colors.success[0], colors.success[1], colors.success[2]);
        doc.text('CONTROLE VALIDE - Produit conforme', 20, yPosition);
      } else if (controlStatus === 'PARTIEL') {
        doc.setTextColor(colors.warning[0], colors.warning[1], colors.warning[2]);
        doc.text('RAPPORT PARTIEL - Controle en cours', 20, yPosition);
      } else {
        doc.setTextColor(colors.danger[0], colors.danger[1], colors.danger[2]);
        doc.text('CONTROLE AVEC RESERVES - Voir details ci-dessus', 20, yPosition);
      }
      doc.setTextColor(0, 0, 0);
      
      // Pied de page
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setFont(undefined, 'italic');
        doc.setTextColor(100, 100, 100);
        doc.text('Rapport genere par Matrice Controle Qualite - Page ' + i + '/' + pageCount, 20, 285);
        doc.text(new Date().toLocaleString('fr-FR'), 150, 285);
      }
      
      // G√©n√©ration du nom de fichier
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T')[0];
      const productRef = (currentProduct[COL_REF] || 'PRODUIT').replace(/[^\w\s-]/g, '').replace(/\s+/g, '_');
      const filename = 'Rapport_QC_' + productRef + '_' + timestamp + '.pdf';
      
      // T√©l√©chargement ou ouverture selon le device
      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        window.open(doc.output('bloburl'));
      } else {
        const blob = doc.output('blob');
        const blobUrl = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = blobUrl;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(blobUrl);
      }
    }

    function resetQualityControl() {
      // Arr√™ter tous les scanners actifs
      if (window.isScanning) stopCamera();
      if (window.isEanScanning) stopEanScanner();
      
      // R√©initialiser l'√©tat des sections
      document.getElementById("step5").classList.add("hidden");
      document.getElementById("step5").classList.remove("active");
      document.getElementById("step4").classList.add("hidden");
      document.getElementById("step4").classList.remove("active");
      document.getElementById("step3").classList.add("hidden");
      document.getElementById("step3").classList.remove("active");
      document.getElementById("step2").classList.add("active");
      document.getElementById("step2").classList.remove("completed");

      // Vider les champs
      document.getElementById("barcodeInput").value = '';
      document.getElementById("results").style.display = "none";

      // R√©initialiser les contr√¥les qualit√© (y compris les photos)
      resetQualityControls();

      // R√©initialiser les variables
      currentProduct = null;
      currentReference = null;
      referenceEanList = [];
      checkedEans.clear();
      nonTestedEans.clear(); // Reset des EAN non test√©s
      packageQualityResults = {};
      productQualityResults = {};

      // Remettre le focus sur la recherche
      document.getElementById("step2").scrollIntoView({ behavior: 'smooth' });
    }

    // Fonction pour ajouter des photos √† un crit√®re
    function addPhotos(criterionName) {
      const fileInput = document.getElementById(`photoInput_${criterionName}`);
      const files = fileInput.files;
      
      if (!files || files.length === 0) {
        alert("‚ö†Ô∏è Veuillez s√©lectionner au moins une photo");
        return;
      }

      // Initialiser le tableau de photos pour ce crit√®re si n√©cessaire
      if (!criterionPhotos[criterionName]) {
        criterionPhotos[criterionName] = [];
      }

      // Traiter chaque fichier s√©lectionn√©
      Array.from(files).forEach(file => {
        // V√©rifier le type de fichier
        if (!file.type.startsWith('image/')) {
          alert(`‚ùå Le fichier "${file.name}" n'est pas une image valide`);
          return;
        }

        // V√©rifier la taille (limite √† 5MB)
        if (file.size > 5 * 1024 * 1024) {
          alert(`‚ùå Le fichier "${file.name}" est trop volumineux (max 5MB)`);
          return;
        }

        // Lire et convertir le fichier en base64
        const reader = new FileReader();
        reader.onload = function(e) {
          const photoData = {
            name: file.name,
            size: file.size,
            type: file.type,
            data: e.target.result, // Base64
            timestamp: new Date().toLocaleString('fr-FR')
          };

          criterionPhotos[criterionName].push(photoData);
          displayPhotos(criterionName);
        };

        reader.onerror = function() {
          alert(`‚ùå Erreur lors de la lecture du fichier "${file.name}"`);
        };

        reader.readAsDataURL(file);
      });

      // Vider l'input file apr√®s traitement
      fileInput.value = '';
    }

    // Fonction pour afficher les photos d'un crit√®re
    function displayPhotos(criterionName) {
      const photosContainer = document.getElementById(`photos_${criterionName}`);
      const photos = criterionPhotos[criterionName] || [];

      if (photos.length === 0) {
        photosContainer.innerHTML = '';
        return;
      }

      photosContainer.innerHTML = photos.map((photo, index) => `
        <div class="photo-item">
          <img src="${photo.data}" alt="${photo.name}" />
          <button class="photo-remove" onclick="removePhoto('${criterionName}', ${index})" title="Supprimer cette photo">
            √ó
          </button>
          <div class="photo-timestamp">${photo.timestamp}</div>
        </div>
      `).join('');
    }

    // Fonction pour supprimer une photo
    function removePhoto(criterionName, photoIndex) {
      if (!criterionPhotos[criterionName]) return;

      if (confirm("üóëÔ∏è √ätes-vous s√ªr de vouloir supprimer cette photo ?")) {
        criterionPhotos[criterionName].splice(photoIndex, 1);
        displayPhotos(criterionName);
        
        // Vibration de confirmation si support√©e
        if (navigator.vibrate) {
          navigator.vibrate(100);
        }
      }
    }

    // Fonction pour initialiser tous les conteneurs de photos
    function initializePhotoContainers() {
      const criterionNames = [
        'shipping_mark', 'package_condition', 'warranty_seal',
        'zip_test', 'button_check', 'color_check', 'finishing_check'
      ];

      criterionNames.forEach(criterionName => {
        if (!criterionPhotos[criterionName]) {
          criterionPhotos[criterionName] = [];
        }
      });
    }

    // Initialiser les conteneurs de photos au chargement de la page
    document.addEventListener('DOMContentLoaded', function() {
      initializePhotoContainers();
      
      const barcodeInput = document.getElementById('barcodeInput');
      if (barcodeInput) {
        barcodeInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            findProduct();
          }
        });
      }

      const eanInput = document.getElementById('eanInput');
      if (eanInput) {
        eanInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            checkEanForReference();
          }
        });
      }
    });

    // Emp√™cher le zoom sur double-tap (iOS)
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
      const now = (new Date()).getTime();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, false);
  </script>
</body>
</html>